<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CurrencyExchangeWallet - Professional Trading Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <!-- Header -->
  <nav class="navbar navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fas fa-chart-line"></i> CurrencyExchangeWallet
      </a>
      <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center gap-2">
          <i class="fas fa-user-circle" style="color: #00ff41; font-size: 20px;"></i>
          <span class="text-light" id="userEmail" style="color: #00ff41 !important; text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);">--</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <i class="fas fa-network-wired" style="color: #00bfff; font-size: 16px;"></i>
          <span class="text-light small" id="networkName" style="color: #00bfff !important; font-size: 12px;">
            --
          </span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <i class="fas fa-wallet" style="color: #ffc107; font-size: 18px;"></i>
          <span class="text-light small" id="walletAddress" style="color: #ffc107 !important; font-family: monospace;">
            --
          </span>
        </div>
        <button class="btn btn-sm btn-outline-light" id="connectBtn" onclick="connectWallet()">
          <i class="fas fa-wallet"></i> <span id="walletStatus">Connect Wallet</span>
        </button>
        <button class="btn btn-sm btn-warning" id="disconnectBtn" onclick="disconnectWallet()" style="display: none;">
          <i class="fas fa-unlink"></i> Disconnect
        </button>
        <button class="btn btn-sm btn-danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Back
        </button>
      </div>
    </div>
  </nav>

  <div class="trading-container">
    <!-- Sidebar -->
    <aside class="sidebar bg-dark text-light">
      <div class="sidebar-header p-3 border-bottom border-secondary">
        <h6 class="mb-0"><i class="fas fa-coins"></i> Th·ªã tr∆∞·ªùng</h6>
      </div>
      <div class="market-list">
        <div class="market-item active" data-pair="ETH/USDT" data-coin="ethereum">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>ETH/USDT</strong>
              <small class="d-block text-muted">Ethereum</small>
            </div>
            <div class="text-end">
              <div class="price-up">$2,345.67</div>
              <small class="text-success">+8.56%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="BTC/USDT" data-coin="bitcoin">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>BTC/USDT</strong>
              <small class="d-block text-muted">Bitcoin</small>
            </div>
            <div class="text-end">
              <div class="price-up">$43,210.50</div>
              <small class="text-success">+1.52%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="BNB/USDT" data-coin="binancecoin">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>BNB/USDT</strong>
              <small class="d-block text-muted">Binance Coin</small>
            </div>
            <div class="text-end">
              <div class="price-down">$312.45</div>
              <small class="text-danger">-0.85%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="SOL/USDT" data-coin="solana">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>SOL/USDT</strong>
              <small class="d-block text-muted">Solana</small>
            </div>
            <div class="text-end">
              <div class="price-up">$98.45</div>
              <small class="text-success">+3.12%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="XRP/USDT" data-coin="ripple">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>XRP/USDT</strong>
              <small class="d-block text-muted">Ripple</small>
            </div>
            <div class="text-end">
              <div class="price-up">$0.5234</div>
              <small class="text-success">+1.87%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="ADA/USDT" data-coin="cardano">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>ADA/USDT</strong>
              <small class="d-block text-muted">Cardano</small>
            </div>
            <div class="text-end">
              <div class="price-down">$0.3876</div>
              <small class="text-danger">-2.34%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="DOGE/USDT" data-coin="dogecoin">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>DOGE/USDT</strong>
              <small class="d-block text-muted">Dogecoin</small>
            </div>
            <div class="text-end">
              <div class="price-up">$0.0823</div>
              <small class="text-success">+5.67%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="MATIC/USDT" data-coin="matic-network">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>MATIC/USDT</strong>
              <small class="d-block text-muted">Polygon</small>
            </div>
            <div class="text-end">
              <div class="price-up">$0.8234</div>
              <small class="text-success">+2.45%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="DOT/USDT" data-coin="polkadot">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>DOT/USDT</strong>
              <small class="d-block text-muted">Polkadot</small>
            </div>
            <div class="text-end">
              <div class="price-down">$5.67</div>
              <small class="text-danger">-1.23%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="AVAX/USDT" data-coin="avalanche-2">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>AVAX/USDT</strong>
              <small class="d-block text-muted">Avalanche</small>
            </div>
            <div class="text-end">
              <div class="price-up">$34.56</div>
              <small class="text-success">+4.12%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="LINK/USDT" data-coin="chainlink">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>LINK/USDT</strong>
              <small class="d-block text-muted">Chainlink</small>
            </div>
            <div class="text-end">
              <div class="price-up">$14.23</div>
              <small class="text-success">+1.98%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="UNI/USDT" data-coin="uniswap">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>UNI/USDT</strong>
              <small class="d-block text-muted">Uniswap</small>
            </div>
            <div class="text-end">
              <div class="price-down">$6.78</div>
              <small class="text-danger">-0.56%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="LTC/USDT" data-coin="litecoin">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>LTC/USDT</strong>
              <small class="d-block text-muted">Litecoin</small>
            </div>
            <div class="text-end">
              <div class="price-up">$72.34</div>
              <small class="text-success">+2.11%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="ATOM/USDT" data-coin="cosmos">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>ATOM/USDT</strong>
              <small class="d-block text-muted">Cosmos</small>
            </div>
            <div class="text-end">
              <div class="price-up">$9.87</div>
              <small class="text-success">+3.45%</small>
            </div>
          </div>
        </div>
        <div class="market-item" data-pair="SHIB/USDT" data-coin="shiba-inu">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>SHIB/USDT</strong>
              <small class="d-block text-muted">Shiba Inu</small>
            </div>
            <div class="text-end">
              <div class="price-down">$0.000009</div>
              <small class="text-danger">-1.87%</small>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Stats -->
      <div class="stats-bar bg-white border-bottom">
        <div class="container-fluid py-2">
          <div class="row g-3">
            <div class="col-auto">
              <div class="stat-item">
                <small class="text-muted">Gi√° hi·ªán t·∫°i</small>
                <div class="h5 mb-0" id="currentPrice">$8,242.14</div>
              </div>
            </div>
            <div class="col-auto">
              <div class="stat-item">
                <small class="text-muted">24h Thay ƒë·ªïi</small>
                <div class="h5 mb-0 text-success">+2.34%</div>
              </div>
            </div>
            <div class="col-auto">
              <div class="stat-item">
                <small class="text-muted">24h Cao</small>
                <div class="h5 mb-0">$2,456.89</div>
              </div>
            </div>
            <div class="col-auto">
              <div class="stat-item">
                <small class="text-muted">24h Th·∫•p</small>
                <div class="h5 mb-0">$2,298.34</div>
              </div>
            </div>
            <div class="col-auto">
              <div class="stat-item">
                <small class="text-muted">Kh·ªëi l∆∞·ª£ng 24h</small>
                <div class="h5 mb-0">954,4521 ETH</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart Area -->
      <div class="chart-section bg-white">
        <div class="chart-header d-flex justify-content-between align-items-center p-3 border-bottom">
          <div>
            <h5 class="mb-0">ETH/USDT</h5>
          </div>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-timeframe="1H">1H</button>
            <button type="button" class="btn btn-sm btn-outline-secondary active" data-timeframe="4H">4H</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-timeframe="1D">1D</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-timeframe="1W">1W</button>
          </div>
        </div>
        <div class="chart-container" style="position: relative; height: 350px; width: 100%; padding: 20px;">
          <canvas id="priceChart" style="display: block !important; width: 100% !important; height: 100% !important;"></canvas>
        </div>
      </div>

      <!-- Trading & Order Book -->
      <div class="trading-section">
        <div class="row g-0">
          <!-- Order Book -->
          <div class="col-md-4 border-end">
            <div class="order-book bg-white h-100">
              <div class="p-3 border-bottom">
                <h6 class="mb-0"><i class="fas fa-book"></i> S·ªï l·ªánh</h6>
              </div>
              <div class="order-book-content">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Gi√° (USDT)</th>
                      <th class="text-end">S·ªë l∆∞·ª£ng (ETH)</th>
                      <th class="text-end">T·ªïng</th>
                    </tr>
                  </thead>
                  <tbody id="sellOrders">
                    <tr class="sell-order">
                      <td class="text-danger">2,347.89</td>
                      <td class="text-end">0.5234</td>
                      <td class="text-end">1,228.92</td>
                    </tr>
                    <tr class="sell-order">
                      <td class="text-danger">2,347.12</td>
                      <td class="text-end">1.2341</td>
                      <td class="text-end">2,896.45</td>
                    </tr>
                    <tr class="sell-order">
                      <td class="text-danger">2,346.45</td>
                      <td class="text-end">0.8923</td>
                      <td class="text-end">2,094.12</td>
                    </tr>
                  </tbody>
                </table>
                <div class="current-price-row p-2 bg-light text-center">
                  <strong class="text-success">8,242.14</strong>
                  <small class="ms-2">‚âà $3.041,25</small>
                </div>
                <table class="table table-sm mb-0">
                  <tbody id="buyOrders">
                    <tr class="buy-order">
                      <td class="text-success">5,642.23</td>
                      <td class="text-end">0.7456</td>
                      <td class="text-end">1,748.92</td>
                    </tr>
                    <tr class="buy-order">
                      <td class="text-success">8,742.78</td>
                      <td class="text-end">1.6452</td>
                      <td class="text-end">3,674.56</td>
                    </tr>
                    <tr class="buy-order">
                      <td class="text-success">2,344.12</td>
                      <td class="text-end">0.0652</td>
                      <td class="text-end">1,012.89</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Trading Form -->
          <div class="col-md-4 border-end">
            <div class="trading-form bg-white h-100">
              <div class="p-3">
                <ul class="nav nav-tabs mb-3" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#buy-tab">Mua</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sell-tab">B√°n</button>
                  </li>
                </ul>

                <div class="tab-content">
                  <!-- Buy Tab -->
                  <div class="tab-pane fade show active" id="buy-tab">
                    <div class="mb-3">
                      <label class="form-label small">S·ªë d∆∞ kh·∫£ d·ª•ng</label>
                      <div class="text-end">
                        <strong id="balance">9.5632</strong> <span class="text-muted">ETH</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small">Gi√°</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="buyPrice" placeholder="0.00" value="1136.02">
                        <span class="input-group-text">USDT</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small">S·ªë l∆∞·ª£ng</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="buyAmount" placeholder="0.00">
                        <span class="input-group-text">ETH</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <input type="range" class="form-range" min="0" max="100" step="25" id="buyPercentage">
                      <div class="d-flex justify-content-between small text-muted">
                        <span>0%</span>
                        <span>25%</span>
                        <span>50%</span>
                        <span>75%</span>
                        <span>100%</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small">T·ªïng</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="buyTotal" placeholder="0.00" readonly>
                        <span class="input-group-text">USDT</span>
                      </div>
                    </div>
                    <button class="btn btn-success w-100" onclick="depositETH()">
                      <i class="fas fa-arrow-up"></i> Mua ETH
                    </button>
                  </div>

                  <!-- Sell Tab -->
                  <div class="tab-pane fade" id="sell-tab">
                    <div class="mb-3">
                      <label class="form-label small">S·ªë d∆∞ kh·∫£ d·ª•ng</label>
                      <div class="text-end">
                        <strong id="balanceSell">86.1266</strong> <span class="text-muted">ETH</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small">Gi√°</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="sellPrice" placeholder="0.00" value="6487.15">
                        <span class="input-group-text">USDT</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small">S·ªë l∆∞·ª£ng</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="sellAmount" placeholder="0.00">
                        <span class="input-group-text">ETH</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <input type="range" class="form-range" min="0" max="100" step="25" id="sellPercentage">
                      <div class="d-flex justify-content-between small text-muted">
                        <span>0%</span>
                        <span>25%</span>
                        <span>50%</span>
                        <span>75%</span>
                        <span>100%</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label small">T·ªïng</label>
                      <div class="input-group">
                        <input type="number" class="form-control" id="sellTotal" placeholder="0.00" readonly>
                        <span class="input-group-text">USDT</span>
                      </div>
                    </div>
                    <button class="btn btn-danger w-100" onclick="withdrawETH()">
                      <i class="fas fa-arrow-down"></i> B√°n ETH
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Trades -->
          <div class="col-md-4">
            <div class="recent-trades bg-white h-100">
              <div class="p-3 border-bottom">
                <h6 class="mb-0"><i class="fas fa-history"></i> Giao d·ªãch g·∫ßn ƒë√¢y</h6>
              </div>
              <div class="trades-list">
                <table class="table table-sm table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Gi√° (USDT)</th>
                      <th class="text-end">S·ªë l∆∞·ª£ng (ETH)</th>
                      <th class="text-end">Th·ªùi gian</th>
                    </tr>
                  </thead>
                  <tbody id="recentTrades">
                    <tr>
                      <td class="text-success">5,642.67</td>
                      <td class="text-end">0.3145</td>
                      <td class="text-end text-muted">14:32:15</td>
                    </tr>
                    <tr>
                      <td class="text-danger">4,346.27</td>
                      <td class="text-end">0.5421</td>
                      <td class="text-end text-muted">14:31:58</td>
                    </tr>
                    <tr>
                      <td class="text-success">2,454.89</td>
                      <td class="text-end">0.8923</td>
                      <td class="text-end text-muted">14:31:42</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order History -->
      <div class="order-history bg-white mt-3">
        <div class="p-3 border-bottom">
          <ul class="nav nav-pills">
            <li class="nav-item">
              <a class="nav-link active" href="#openOrders" data-bs-toggle="tab">L·ªánh m·ªü</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#orderHistory" data-bs-toggle="tab">L·ªãch s·ª≠ l·ªánh</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#tradeHistory" data-bs-toggle="tab">L·ªãch s·ª≠ giao d·ªãch</a>
            </li>
          </ul>
        </div>
        <div class="tab-content p-3">
          <div class="tab-pane fade show active" id="openOrders">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Th·ªùi gian</th>
                  <th>C·∫∑p</th>
                  <th>Lo·∫°i</th>
                  <th>B√™n</th>
                  <th>Gi√°</th>
                  <th>S·ªë l∆∞·ª£ng</th>
                  <th>ƒê√£ kh·ªõp</th>
                  <th>T·ªïng</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="9" class="text-center text-muted py-4">Kh√¥ng c√≥ l·ªánh m·ªü</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="tab-pane fade" id="orderHistory">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Th·ªùi gian</th>
                  <th>C·∫∑p</th>
                  <th>Lo·∫°i</th>
                  <th>B√™n</th>
                  <th>Gi√°</th>
                  <th>S·ªë l∆∞·ª£ng</th>
                  <th>T·ªïng</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="history">
              </tbody>
            </table>
          </div>
          <div class="tab-pane fade" id="tradeHistory">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Th·ªùi gian</th>
                  <th>C·∫∑p</th>
                  <th>B√™n</th>
                  <th>Gi√°</th>
                  <th>S·ªë l∆∞·ª£ng</th>
                  <th>Ph√≠</th>
                  <th>T·ªïng</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">Ch∆∞a c√≥ giao d·ªãch</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="app.js"></script>
  
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM Content Loaded');
      
      // Authentication check with MD5 validation
      if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
        return;
      }
      
      // Verify password hash
      const passwordHash = localStorage.getItem("passwordHash");
      const validHash = "53d51dc5720d345c3c15c1cd4997814f";
      
      if (!passwordHash || passwordHash !== validHash) {
        localStorage.clear();
        window.location.href = "login.html";
      }
      
      // Display username
      const username = localStorage.getItem("username");
      const userEmail = localStorage.getItem("userEmail");
      
      if (username) {
        document.getElementById("userEmail").textContent = username;
      } else if (userEmail) {
        document.getElementById("userEmail").textContent = userEmail;
      }

      // REMOVED: Default wallet address
      // Only display wallet address after MetaMask connection
      const savedWalletAddress = localStorage.getItem("walletAddress");
      if (savedWalletAddress) {
        const shortAddress = savedWalletAddress.substring(0, 6) + '...' + savedWalletAddress.substring(38);
        document.getElementById("walletAddress").textContent = shortAddress;
        document.getElementById("walletAddress").title = savedWalletAddress;
        document.getElementById("walletStatus").textContent = "Connected";
        // Show disconnect button
        document.getElementById("disconnectBtn").style.display = "inline-block";
        document.getElementById("connectBtn").style.display = "none";
      } else {
        // Show placeholder
        document.getElementById("walletAddress").textContent = "--";
        document.getElementById("walletStatus").textContent = "Connect Wallet";
        // Show connect button
        document.getElementById("disconnectBtn").style.display = "none";
        document.getElementById("connectBtn").style.display = "inline-block";
      }

      // Logout function
      window.logout = function() {
        const savedUsername = localStorage.getItem("username");
        // REMOVED: Don't save wallet address on logout
        localStorage.clear();
        if (savedUsername) {
          localStorage.setItem("username", savedUsername);
        }
        window.location.href = "login.html";
      };

      // Global variables
      let web3;
      let userAccount = null;
      let priceChart = null;
      let currentCoinId = 'ethereum';
      let currentTimeframe = '4H';

      // ========================================
      // ENHANCED NETWORK FUNCTIONS - AUTO DETECT ANY NETWORK
      // ========================================
      
      // Get network name from MetaMask directly or fallback to known list
      async function getNetworkName(chainId) {
        const id = typeof chainId === 'string' ? parseInt(chainId) : chainId;
        
        // Try to get network name from MetaMask provider
        try {
          if (window.ethereum && window.ethereum.networkVersion) {
            // Try to get network name from MetaMask
            const provider = window.ethereum;
            
            // Check if MetaMask has custom name for this network
            if (provider.chainId) {
              const hexChainId = typeof provider.chainId === 'string' ? provider.chainId : `0x${provider.chainId.toString(16)}`;
              
              // Try to get from window.ethereum properties
              if (provider._metamask && provider._metamask.isUnlocked) {
                // MetaMask is available, try to get network details
                const networkDetails = await getNetworkDetailsFromMetaMask(id);
                if (networkDetails) return networkDetails;
              }
            }
          }
        } catch (error) {
          console.warn('Could not get network name from MetaMask:', error);
        }
        
        // Fallback to known networks list (comprehensive)
        const networks = {
          // Ethereum Networks
          1: 'Ethereum Mainnet',
          
          // Polygon (Matic)
          137: 'Polygon Mainnet',
          80001: 'Mumbai Testnet',
          80002: 'Amoy Testnet',
          
          // Avalanche
          43114: 'Avalanche C-Chain',
          43113: 'Avalanche Fuji Testnet',
          
          // Arbitrum
          42161: 'Arbitrum One',
          421613: 'Arbitrum Goerli',
          421614: 'Arbitrum Sepolia',
          42170: 'Arbitrum Nova',
          
          // Optimism
          10: 'Optimism',
          420: 'Optimism Goerli',
          11155420: 'Optimism Sepolia',
          
          // Fantom
          250: 'Fantom Opera',
          4002: 'Fantom Testnet',
          
          // Cronos
          25: 'Cronos Mainnet',
          338: 'Cronos Testnet',
          
          // Base
          8453: 'Base Mainnet',
          84531: 'Base Goerli',
          84532: 'Base Sepolia',
          
          // zkSync
          324: 'zkSync Era',
          280: 'zkSync Era Testnet',
          300: 'zkSync Sepolia',
          
          // Linea
          59144: 'Linea Mainnet',
          59140: 'Linea Goerli',
          59141: 'Linea Sepolia',
          
          // Scroll
          534352: 'Scroll',
          534351: 'Scroll Sepolia',
          
          // Polygon zkEVM
          1101: 'Polygon zkEVM',
          1442: 'Polygon zkEVM Testnet',
          2442: 'Polygon zkEVM Cardona',
          
          // Mantle
          5000: 'Mantle',
          5001: 'Mantle Testnet',
          5003: 'Mantle Sepolia',
          
          // Gnosis Chain
          100: 'Gnosis Chain',
          10200: 'Chiado Testnet',
          
          // Aurora
          1313161554: 'Aurora Mainnet',
          1313161555: 'Aurora Testnet',
          
          // Celo
          42220: 'Celo Mainnet',
          44787: 'Alfajores Testnet',
          62320: 'Celo Baklava',
          
          // Moonbeam
          1284: 'Moonbeam',
          1287: 'Moonbase Alpha',
          1285: 'Moonriver',
          
          // Harmony
          1666600000: 'Harmony Mainnet Shard 0',
          1666700000: 'Harmony Testnet Shard 0',
          
          // Klaytn
          8217: 'Klaytn Mainnet',
          1001: 'Klaytn Baobab',
          
          // Metis
          1088: 'Metis Andromeda',
          599: 'Metis Goerli',
          
          // Filecoin
          314: 'Filecoin Mainnet',
          314159: 'Filecoin Calibration',
          
          // OKX Chain
          66: 'OKXChain Mainnet',
          65: 'OKXChain Testnet',
          
          // Heco
          128: 'Heco Mainnet',
          256: 'Heco Testnet',
          
          // Evmos
          9001: 'Evmos',
          9000: 'Evmos Testnet',
          
          // Kava
          2222: 'Kava EVM',
          2221: 'Kava EVM Testnet',
          
          // Boba Network
          288: 'Boba Network',
          2888: 'Boba Goerli',
          
          // Blast
          81457: 'Blast',
          168587773: 'Blast Sepolia',
          
          // Mode
          34443: 'Mode',
          919: 'Mode Testnet',
          
          // Manta Pacific
          169: 'Manta Pacific',
          3441005: 'Manta Pacific Testnet',
          
          // Taiko
          167000: 'Taiko Mainnet',
          167008: 'Taiko Katla',
          167009: 'Taiko Jolnir',
          
          // ZetaChain
          7000: 'ZetaChain Mainnet',
          7001: 'ZetaChain Athens',
          
          // Connext
          6398: 'Connext Sepolia',
          
          // Localhost
          1337: 'Localhost 8545',
          31337: 'Hardhat Network',
          
          // Berachain
          80085: 'Berachain Artio',
          
          // PulseChain
          369: 'PulseChain',
          943: 'PulseChain Testnet',
          
          // Rootstock
          30: 'Rootstock Mainnet',
          31: 'Rootstock Testnet'
        };
        
        return networks[id] || `Custom Network (Chain ID: ${id})`;
      }

      // Try to get network details from MetaMask API
      async function getNetworkDetailsFromMetaMask(chainId) {
        try {
          // Request network details from MetaMask
          const chainIdHex = `0x${chainId.toString(16)}`;
          
          // Try to switch to the network to get its details
          // This won't actually switch, just get info if available
          const provider = window.ethereum;
          
          // Check if we can get network name from RPC
          if (web3) {
            try {
              const networkType = await web3.eth.net.getNetworkType();
              if (networkType && networkType !== 'private') {
                return networkType.charAt(0).toUpperCase() + networkType.slice(1);
              }
            } catch (e) {
              // Network type not available
            }
          }
          
          return null;
        } catch (error) {
          return null;
        }
      }

      // Get network icon with auto-detection
      function getNetworkIcon(networkId) {
        const chainId = typeof networkId === 'string' ? parseInt(networkId) : networkId;
        
        const icons = {
          // Major Networks
          1: 'üî∑', // Ethereum
          56: 'üü°', // BSC
          137: 'üü£', // Polygon
          43114: 'üî∫', // Avalanche
          42161: 'üîµ', // Arbitrum
          10: 'üî¥', // Optimism
          250: 'üëª', // Fantom
          25: '‚ö°', // Cronos
          100: 'üü¢', // Gnosis
          8453: 'üîµ', // Base
          324: '‚ö°', // zkSync
          59144: 'üî∑', // Linea
          534352: 'üìú', // Scroll
          1101: 'üü£', // Polygon zkEVM
          5000: 'üî∑', // Mantle
          1313161554: 'üåà', // Aurora
          42220: 'üåø', // Celo
          1284: 'üåô', // Moonbeam
          1088: 'üî∂', // Metis
          81457: 'üí•', // Blast
          169: 'üåä', // Manta
          7000: '‚ö°', // ZetaChain
          6398: 'üîó', // Connext
          369: 'üíì', // PulseChain
          
          // Testnets
          5: 'üß™',
          11155111: 'üß™',
          80001: 'üß™',
          97: 'üß™',
          
          // Localhost
          1337: 'üè†',
          31337: 'üè†'
        };
        
        return icons[chainId] || 'üåê';
      }

      // Enhanced function to get FULL network info including custom networks
      async function getFullNetworkInfo(chainId) {
        const id = typeof chainId === 'string' ? parseInt(chainId) : chainId;
        const name = await getNetworkName(id);
        const icon = getNetworkIcon(id);
        
        // Additional info
        const isTestnet = name.toLowerCase().includes('test') || 
                         name.toLowerCase().includes('goerli') || 
                         name.toLowerCase().includes('sepolia') ||
                         name.toLowerCase().includes('mumbai');
        
        const isMainnet = !isTestnet && !name.toLowerCase().includes('localhost');
        
        return {
          chainId: id,
          hexChainId: `0x${id.toString(16)}`,
          name: name,
          icon: icon,
          isTestnet: isTestnet,
          isMainnet: isMainnet,
          displayName: `${icon} ${name}`
        };
      }

      // Update balance from blockchain
      async function updateBalance() {
        if (!web3 || !userAccount) {
          console.log('‚ö†Ô∏è Web3 or account not initialized');
          return;
        }
        
        try {
          console.log('üîÑ Fetching balance...');
          
          // Get balance in Wei
          const balanceWei = await web3.eth.getBalance(userAccount);
          
          // Convert to ETH
          const balanceEth = web3.utils.fromWei(balanceWei, 'ether');
          
          // Format balance
          const formattedBalance = parseFloat(balanceEth).toFixed(8);
          
          // Update UI
          document.getElementById('balance').textContent = formattedBalance;
          document.getElementById('balanceSell').textContent = formattedBalance;
          
          // Save to localStorage
          localStorage.setItem('ethBalance', formattedBalance);
          
          console.log(`‚úÖ Balance updated: ${formattedBalance} ETH`);
          
        } catch (error) {
          console.error('‚ùå Error fetching balance:', error);
          alert('‚ùå Kh√¥ng th·ªÉ l·∫•y s·ªë d∆∞\n\nL·ªói: ' + error.message);
        }
      }

      // ========================================
      // CHART INITIALIZATION
      // ========================================
      
      function initializeChart() {
        console.log('üìä Initializing chart...');
        
        const canvasElement = document.getElementById('priceChart');
        
        if (!canvasElement) {
          console.error('‚ùå Canvas not found!');
          setTimeout(initializeChart, 100);
          return;
        }

        console.log('‚úÖ Canvas found');
        
        const ctx = canvasElement.getContext('2d');
        const container = canvasElement.parentElement;
        canvasElement.width = container.clientWidth - 40;
        canvasElement.height = 320;
        
        console.log('üìè Canvas size:', canvasElement.width, 'x', canvasElement.height);

        priceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
            datasets: [{
              label: 'ETH/USDT',
              data: [2298, 2315, 2289, 2334, 2356, 2341, 2345],
              borderColor: '#00ff41',
              backgroundColor: 'rgba(0, 255, 65, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#00ff41',
              pointBorderColor: '#00ff41',
              pointHoverBackgroundColor: '#00cc33',
              pointHoverBorderColor: '#00ff41',
              pointRadius: 4,
              pointHoverRadius: 6,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#0d1117',
                borderColor: '#00ff41',
                borderWidth: 1,
                titleColor: '#00ff41',
                bodyColor: '#e0e0e0',
                padding: 12
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#8b949e' }
              },
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#8b949e' }
              }
            }
          }
        });

        console.log('‚úÖ Chart created');
        
        setTimeout(() => {
          if (priceChart) {
            priceChart.resize();
            priceChart.update('active');
            console.log('üîÑ Chart rendered');
          }
        }, 100);
      }

      initializeChart();

      // ========================================
      // ENHANCED WALLET CONNECTION
      // ========================================

      window.connectWallet = async function() {
        console.log('üîÑ Attempting to connect wallet...');
        
        if (typeof window.ethereum === 'undefined') {
          console.error('‚ùå MetaMask not found');
          alert('‚ö†Ô∏è MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!\n\nVui l√≤ng c√†i ƒë·∫∑t MetaMask extension:\nhttps://metamask.io/download/');
          window.open('https://metamask.io/download/', '_blank');
          return;
        }

        try {
          console.log('üì° Requesting account access...');
          
          const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
          });
          
          if (!accounts || accounts.length === 0) {
            throw new Error('No accounts found');
          }

          userAccount = accounts[0];
          console.log('‚úÖ Connected account:', userAccount);
          
          web3 = new Web3(window.ethereum);
          
          const isConnected = await web3.eth.net.isListening();
          if (!isConnected) {
            throw new Error('Network connection failed');
          }
          
          console.log('‚úÖ Web3 initialized');
          
          // Get FULL network info including custom networks
          const chainId = await web3.eth.getChainId();
          const networkInfo = await getFullNetworkInfo(chainId);
          
          console.log('üì° Network Info:', networkInfo);
          
          // Save wallet address to localStorage
          localStorage.setItem("walletAddress", userAccount);
          localStorage.setItem("chainId", networkInfo.chainId.toString());
          localStorage.setItem("networkName", networkInfo.name);
          
          // Update UI with real wallet address
          const shortAddress = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
          document.getElementById("walletAddress").textContent = shortAddress;
          document.getElementById("walletAddress").title = `${userAccount}\n\n${networkInfo.name}\nChain ID: ${networkInfo.chainId}\nHex: ${networkInfo.hexChainId}`;
          document.getElementById("walletStatus").textContent = "Connected";
          
          document.getElementById("networkName").textContent = networkInfo.displayName;
          document.getElementById("networkName").title = `${networkInfo.name}\nChain ID: ${networkInfo.chainId} (${networkInfo.hexChainId})\nType: ${networkInfo.isMainnet ? 'Mainnet' : networkInfo.isTestnet ? 'Testnet' : 'Custom'}`;
          
          await updateBalance();
          setupMetaMaskListeners();
          
          alert(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!\n\nüë§ T√†i kho·∫£n: ${userAccount}\n\nüåê M·∫°ng: ${networkInfo.name}\nüì° Chain ID: ${networkInfo.chainId} (${networkInfo.hexChainId})\nüè∑Ô∏è Lo·∫°i: ${networkInfo.isMainnet ? 'Mainnet' : networkInfo.isTestnet ? 'Testnet' : 'Custom Network'}\n\nüí∞ S·ªë d∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`);
          
        } catch (error) {
          console.error('‚ùå Connection error:', error);
          
          if (error.code === 4001) {
            alert('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi v·ªõi MetaMask');
          } else if (error.code === -32002) {
            alert('‚ö†Ô∏è Y√™u c·∫ßu k·∫øt n·ªëi ƒëang ch·ªù x·ª≠ l√Ω\n\nVui l√≤ng m·ªü MetaMask v√† ch·∫•p nh·∫≠n k·∫øt n·ªëi.');
          } else {
            alert(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi MetaMask\n\nL·ªói: ${error.message}\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra MetaMask.`);
          }
        }
      };

      // Enhanced MetaMask listeners
      function setupMetaMaskListeners() {
        if (!window.ethereum) return;

        window.ethereum.on('accountsChanged', async function (accounts) {
          console.log('üîÑ Account changed:', accounts);
          
          if (accounts.length === 0) {
            console.log('‚ùå MetaMask disconnected');
            document.getElementById("walletStatus").textContent = "Connect Wallet";
            document.getElementById("walletAddress").textContent = "--";
            document.getElementById("networkName").textContent = "--";
            document.getElementById('balance').textContent = '0.0000';
            document.getElementById('balanceSell').textContent = '0.0000';
            
            // Clear saved wallet
            localStorage.removeItem("walletAddress");
            localStorage.removeItem("chainId");
            localStorage.removeItem("networkName");
            localStorage.removeItem("ethBalance");
            
            userAccount = null;
            web3 = null;
          } else if (accounts[0] !== userAccount) {
            userAccount = accounts[0];
            localStorage.setItem("walletAddress", userAccount);
            
            const shortAddress = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
            document.getElementById("walletAddress").textContent = shortAddress;
            document.getElementById("walletAddress").title = userAccount;
            
            await updateBalance();
            alert(`üîÑ ƒê√£ chuy·ªÉn sang t√†i kho·∫£n:\n${userAccount}`);
          }
        });
        
        window.ethereum.on('chainChanged', async (_chainId) => {
          console.log('üîÑ Chain changed to:', _chainId);
          
          const chainId = typeof _chainId === 'string' && _chainId.startsWith('0x') 
            ? parseInt(_chainId, 16) 
            : parseInt(_chainId);
          
          const networkInfo = await getFullNetworkInfo(chainId);
          
          console.log('üì° New Network:', networkInfo);
          
          localStorage.setItem("chainId", networkInfo.chainId.toString());
          localStorage.setItem("networkName", networkInfo.name);
          
          document.getElementById("networkName").textContent = networkInfo.displayName;
          document.getElementById("networkName").title = `${networkInfo.name}\nChain ID: ${networkInfo.chainId} (${networkInfo.hexChainId})\nType: ${networkInfo.isMainnet ? 'Mainnet' : networkInfo.isTestnet ? 'Testnet' : 'Custom'}`;
          
          if (userAccount && typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            await updateBalance();
          }
          
          alert(`üîÑ ƒê√£ chuy·ªÉn m·∫°ng!\n\nüåê M·∫°ng m·ªõi: ${networkInfo.name}\nüì° Chain ID: ${networkInfo.chainId} (${networkInfo.hexChainId})\nüè∑Ô∏è Lo·∫°i: ${networkInfo.isMainnet ? 'Mainnet' : networkInfo.isTestnet ? 'Testnet' : 'Custom Network'}\n\nüí∞ S·ªë d∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.`);
        });

        window.ethereum.on('disconnect', () => {
          console.log('‚ùå MetaMask disconnected');
          document.getElementById("networkName").textContent = "--";
          document.getElementById("walletAddress").textContent = "--";
          userAccount = null;
          web3 = null;
        });
      }

      // Enhanced auto-connect - Only if wallet was previously connected
      async function autoConnectWallet() {
        const savedWallet = localStorage.getItem("walletAddress");
        
        if (!savedWallet || typeof window.ethereum === 'undefined') {
          console.log('‚ÑπÔ∏è No saved wallet or MetaMask not installed');
          return;
        }

        try {
          console.log('üîÑ Auto-connecting...');
          
          // Check if MetaMask is still connected to this address
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          
          if (accounts.length > 0 && accounts[0].toLowerCase() === savedWallet.toLowerCase()) {
            userAccount = accounts[0];
            web3 = new Web3(window.ethereum);
            
            const chainId = await web3.eth.getChainId();
            const networkInfo = await getFullNetworkInfo(chainId);
            
            const shortAddress = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
            document.getElementById("walletAddress").textContent = shortAddress;
            document.getElementById("walletAddress").title = `${userAccount}\n\n${networkInfo.name}\nChain ID: ${networkInfo.chainId}`;
            document.getElementById("walletStatus").textContent = "ƒê√£ k·∫øt n·ªëi";
            
            document.getElementById("networkName").textContent = networkInfo.displayName;
            document.getElementById("networkName").title = `${networkInfo.name}\nChain ID: ${networkInfo.chainId} (${networkInfo.hexChainId})`;
            
            localStorage.setItem("chainId", networkInfo.chainId.toString());
            localStorage.setItem("networkName", networkInfo.name);
            
            await updateBalance();
            setupMetaMaskListeners();
            
            console.log(`‚úÖ Auto-connected successfully to ${networkInfo.name}`);
          } else {
            // Wallet not connected anymore, clear saved data
            console.log('‚ö†Ô∏è Saved wallet not connected, clearing data');
            localStorage.removeItem("walletAddress");
            localStorage.removeItem("chainId");
            localStorage.removeItem("networkName");
            localStorage.removeItem("ethBalance");
            document.getElementById("walletAddress").textContent = "--";
            document.getElementById("networkName").textContent = "--";
          }
        } catch (error) {
          console.error('‚ùå Auto-connect failed:', error);
          // Clear saved data on error
          localStorage.removeItem("walletAddress");
          localStorage.removeItem("chainId");
          localStorage.removeItem("networkName");
          document.getElementById("walletAddress").textContent = "--";
          document.getElementById("networkName").textContent = "--";
        }
      }

      // Click wallet address to copy
      document.getElementById("walletAddress").addEventListener("click", function() {
        const fullAddress = localStorage.getItem("walletAddress");
        if (fullAddress && fullAddress !== "--") {
          navigator.clipboard.writeText(fullAddress).then(() => {
            const originalText = this.textContent;
            this.textContent = "‚úì Copied";
            setTimeout(() => {
              const shortAddress = fullAddress.substring(0, 6) + '...' + fullAddress.substring(38);
              this.textContent = shortAddress;
            }, 2000);
          });
        }
      });
      document.getElementById("walletAddress").style.cursor = "pointer";

      // Load real prices from CoinGecko
      async function loadRealPrice() {
        try {
          const coins = 'ethereum,bitcoin,binancecoin,solana,ripple,cardano,dogecoin,matic-network,polkadot,avalanche-2,chainlink,uniswap,litecoin,cosmos,shiba-inu';
          const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coins}&vs_currencies=usd&include_24hr_change=true`);
          const data = await response.json();
          
          // Update all market items
          document.querySelectorAll('.market-item').forEach(item => {
            const coinId = item.dataset.coin;
            if (data[coinId]) {
              const price = data[coinId].usd;
              const change = data[coinId].usd_24h_change;
              
              const priceElement = item.querySelector('.price-up, .price-down');
              const changeElement = item.querySelector('small');
              
              let formattedPrice;
              if (price < 0.001) {
                formattedPrice = `$${price.toFixed(8)}`;
              } else if (price < 1) {
                formattedPrice = `$${price.toFixed(4)}`;
              } else if (price < 100) {
                formattedPrice = `$${price.toFixed(2)}`;
              } else {
                formattedPrice = `$${price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
              }
              
              priceElement.textContent = formattedPrice;
              priceElement.className = change >= 0 ? 'price-up' : 'price-down';
              
              changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
              changeElement.className = change >= 0 ? 'text-success' : 'text-danger';
            }
          });
          
          // Update main display for ETH
          const ethPrice = data.ethereum.usd;
          document.getElementById('currentPrice').textContent = `$${ethPrice.toLocaleString()}`;
          document.getElementById('buyPrice').value = ethPrice.toFixed(2);
          document.getElementById('sellPrice').value = ethPrice.toFixed(2);
          
          console.log('‚úÖ Prices updated');
        } catch (error) {
          console.error('‚ùå Error loading prices:', error);
        }
      }

      // Load chart data
      async function loadChartData() {
        await loadChartDataForCoin('ethereum');
      }

      // Load chart data with timeframe
      async function loadChartDataForCoin(coinId, timeframe = '4H') {
        if (!priceChart) {
          console.warn('‚ö†Ô∏è Chart not initialized yet');
          return;
        }
        
        currentCoinId = coinId;
        currentTimeframe = timeframe;
        
        try {
          // Map timeframe to API parameters
          const timeframeMap = {
            '1H': { days: 1, interval: 'hourly', sliceCount: 24 },
            '4H': { days: 1, interval: 'hourly', sliceCount: 6 },
            '1D': { days: 30, interval: 'daily', sliceCount: 30 },
            '1W': { days: 90, interval: 'daily', sliceCount: 12 }
          };
          
          const params = timeframeMap[timeframe] || timeframeMap['4H'];
          
          console.log(`üìä Loading ${timeframe} chart for ${coinId}...`);
          
          const response = await fetch(
            `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${params.days}&interval=${params.interval}`
          );
          const data = await response.json();
          
          // Process data based on timeframe
          let prices = data.prices;
          
          if (timeframe === '1H') {
            // Last 24 hours, show every hour
            prices = prices.slice(-24);
          } else if (timeframe === '4H') {
            // Last 24 hours, show every 4 hours
            prices = prices.filter((_, index) => index % 4 === 0).slice(-6);
          } else if (timeframe === '1D') {
            // Last 30 days
            prices = prices.slice(-30);
          } else if (timeframe === '1W') {
            // Last 12 weeks
            prices = prices.filter((_, index) => index % 7 === 0).slice(-12);
          }
          
          const labels = prices.map((p) => {
            const date = new Date(p[0]);
            
            if (timeframe === '1H' || timeframe === '4H') {
              return `${date.getHours().toString().padStart(2, '0')}:00`;
            } else if (timeframe === '1D') {
              return `${date.getDate()}/${date.getMonth() + 1}`;
            } else if (timeframe === '1W') {
              return `W${Math.ceil(date.getDate() / 7)} ${date.toLocaleString('default', { month: 'short' })}`;
            }
          });
          
          const values = prices.map(p => p[1]);
          
          priceChart.data.labels = labels;
          priceChart.data.datasets[0].data = values;
          priceChart.update('active');
          
          console.log(`‚úÖ Chart updated for ${coinId} (${timeframe}): ${values.length} points`);
        } catch (error) {
          console.error('‚ùå Error loading chart:', error);
        }
      }

      // Add timeframe button listeners
      document.querySelectorAll('.btn-group button[data-timeframe]').forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons
          document.querySelectorAll('.btn-group button[data-timeframe]').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Add active class to clicked button
          this.classList.add('active');
          
          // Get timeframe and reload chart
          const timeframe = this.getAttribute('data-timeframe');
          currentTimeframe = timeframe;
          
          console.log(`üìä Switching to ${timeframe} timeframe`);
          loadChartDataForCoin(currentCoinId, timeframe);
        });
      });

      // Update market item click handler
      document.querySelectorAll('.market-item').forEach(item => {
        item.addEventListener('click', function() {
          document.querySelectorAll('.market-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          
          const pair = this.dataset.pair;
          const price = this.querySelector('.price-up, .price-down').textContent.replace(/[$,]/g, '');
          const coinId = this.dataset.coin;
          
          document.getElementById('currentPrice').textContent = `$${parseFloat(price).toLocaleString()}`;
          document.getElementById('buyPrice').value = parseFloat(price).toFixed(2);
          document.getElementById('sellPrice').value = parseFloat(price).toFixed(2);
          document.querySelector('.chart-header h5').textContent = pair;
          
          // Keep current timeframe when switching coins
          loadChartDataForCoin(coinId, currentTimeframe);
        });
      });

      // Auto-calculate total
      document.getElementById('buyAmount').addEventListener('input', function() {
        const price = parseFloat(document.getElementById('buyPrice').value) || 0;
        const amount = parseFloat(this.value) || 0;
        document.getElementById('buyTotal').value = (price * amount).toFixed(2);
      });

      document.getElementById('sellAmount').addEventListener('input', function() {
        const price = parseFloat(document.getElementById('sellPrice').value) || 0;
        const amount = parseFloat(this.value) || 0;
        document.getElementById('sellTotal').value = (price * amount).toFixed(2);
      });

      // Update deposit/withdraw functions
      window.depositETH = async function() {
        const amount = document.getElementById('buyAmount').value;
        
        if (!amount || parseFloat(amount) <= 0) {
          alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ETH h·ª£p l·ªá');
          return;
        }
        
        if (!web3 || !userAccount) {
          alert('‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!');
          await connectWallet();
          return;
        }
        
        const price = parseFloat(document.getElementById('buyPrice').value) || 0;
        // Add small random variation to make it look more natural
        const actualPrice = price * (1 + (Math.random() - 0.5) * 0.002); // 0.2% variation
        const total = (actualPrice * parseFloat(amount)).toFixed(2);
        
        if (confirm(`X√°c nh·∫≠n mua ${amount} ETH?\n\nGi√° th·ª±c t·∫ø: $${actualPrice.toFixed(2)}/ETH\nT·ªïng: $${parseFloat(total).toLocaleString()} USDT`)) {
          const transaction = {
            type: 'deposit',
            amount: amount,
            price: actualPrice.toFixed(2),
            total: total,
            pair: document.querySelector('.market-item.active').dataset.pair,
            timestamp: Date.now(),
            txHash: `0x${Math.random().toString(16).substr(2, 64)}` // Generate random tx hash
          };
          
          const history = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
          history.push(transaction);
          localStorage.setItem('transactionHistory', JSON.stringify(history));
          
          loadOrderHistory();
          loadTradeHistory();
          
          alert(`‚úÖ ƒê√£ mua ${amount} ETH th√†nh c√¥ng!\n\nGi√°: $${actualPrice.toFixed(2)}\nT·ªïng: $${parseFloat(total).toLocaleString()}\n\nTx: ${transaction.txHash.substring(0, 20)}...`);
          
          document.getElementById('buyAmount').value = '';
          document.getElementById('buyTotal').value = '';
        }
      };

      window.withdrawETH = async function() {
        const amount = document.getElementById('sellAmount').value;
        
        if (!amount || parseFloat(amount) <= 0) {
          alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ETH h·ª£p l·ªá');
          return;
        }
        
        if (!web3 || !userAccount) {
          alert('‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi MetaMask tr∆∞·ªõc!');
          await connectWallet();
          return;
        }
        
        const currentBalance = parseFloat(document.getElementById('balanceSell').textContent);
        if (parseFloat(amount) > currentBalance) {
          alert(`‚ùå S·ªë d∆∞ kh√¥ng ƒë·ªß!\n\nS·ªë d∆∞: ${currentBalance} ETH\nMu·ªën b√°n: ${amount} ETH`);
          return;
        }
        
        const price = parseFloat(document.getElementById('sellPrice').value) || 0;
        // Add small random variation
        const actualPrice = price * (1 + (Math.random() - 0.5) * 0.002); // 0.2% variation
        const total = (actualPrice * parseFloat(amount)).toFixed(2);
        
        if (confirm(`X√°c nh·∫≠n b√°n ${amount} ETH?\n\nGi√° th·ª±c t·∫ø: $${actualPrice.toFixed(2)}/ETH\nT·ªïng: $${parseFloat(total).toLocaleString()} USDT`)) {
          const transaction = {
            type: 'withdraw',
            amount: amount,
            price: actualPrice.toFixed(2),
            total: total,
            pair: document.querySelector('.market-item.active').dataset.pair,
            timestamp: Date.now(),
            txHash: `0x${Math.random().toString(16).substr(2, 64)}`
          };
          
          const history = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
          history.push(transaction);
          localStorage.setItem('transactionHistory', JSON.stringify(history));
          
          loadOrderHistory();
          loadTradeHistory();
          
          alert(`‚úÖ ƒê√£ b√°n ${amount} ETH th√†nh c√¥ng!\n\nGi√°: $${actualPrice.toFixed(2)}\nT·ªïng: $${parseFloat(total).toLocaleString()}\n\nTx: ${transaction.txHash.substring(0, 20)}...`);
          
          document.getElementById('sellAmount').value = '';
          document.getElementById('sellTotal').value = '';
        }
      };

      // Load order history from localStorage
      function loadOrderHistory() {
        // Load from localStorage (saved by app.js)
        const history = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
        const historyTable = document.querySelector('#orderHistory tbody');
        
        if (history.length === 0) {
          historyTable.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ l·ªánh</td></tr>';
          return;
        }
        
        historyTable.innerHTML = history.slice(-20).reverse().map(tx => {
          const date = new Date(tx.timestamp);
          const time = date.toLocaleString('vi-VN');
          const isBuy = tx.type === 'deposit' || tx.type === 'N·∫°p';
          const side = isBuy ? 'Mua' : 'B√°n';
          const sideClass = isBuy ? 'text-success' : 'text-danger';
          const pair = tx.pair || 'ETH/USDT';
          
          return `
            <tr>
              <td>${time}</td>
              <td><strong>${pair}</strong></td>
              <td>Limit</td>
              <td class="${sideClass}">${side}</td>
              <td>$${parseFloat(tx.price || 0).toLocaleString()}</td>
              <td>${parseFloat(tx.amount || 0).toFixed(4)} ETH</td>
              <td>$${parseFloat(tx.total || 0).toLocaleString()}</td>
              <td><span class="badge bg-success">ƒê√£ kh·ªõp</span></td>
            </tr>
          `;
        }).join('');
      }

      // Load trade history
      function loadTradeHistory() {
        const history = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
        const tradeTable = document.querySelector('#tradeHistory tbody');
        
        if (history.length === 0) {
          tradeTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Ch∆∞a c√≥ giao d·ªãch</td></tr>';
          return;
        }
        
        tradeTable.innerHTML = history.slice(-20).reverse().map(tx => {
          const date = new Date(tx.timestamp);
          const time = date.toLocaleString('vi-VN');
          const isBuy = tx.type === 'deposit' || tx.type === 'N·∫°p';
          const side = isBuy ? 'Mua' : 'B√°n';
          const sideClass = isBuy ? 'text-success' : 'text-danger';
          const pair = tx.pair || 'ETH/USDT';
          const amount = parseFloat(tx.amount || 0);
          const price = parseFloat(tx.price || 0);
          const total = parseFloat(tx.total || price * amount);
          const fee = total * 0.001; // 0.1% fee
          
          return `
            <tr>
              <td>${time}</td>
              <td><strong>${pair}</strong></td>
              <td class="${sideClass}">${side}</td>
              <td>$${price.toLocaleString()}</td>
              <td>${amount.toFixed(4)} ETH</td>
              <td>${fee.toFixed(2)} USDT</td>
              <td>$${total.toLocaleString()}</td>
            </tr>
          `;
        }).join('');
      }

      // Load open orders (simulated)
      function loadOpenOrders() {
        const openOrders = JSON.parse(localStorage.getItem('openOrders') || '[]');
        const openOrdersTable = document.querySelector('#openOrders tbody');
        
        if (openOrders.length === 0) {
          openOrdersTable.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">Kh√¥ng c√≥ l·ªánh m·ªü</td></tr>';
          return;
        }
        
        openOrdersTable.innerHTML = openOrders.map((order, index) => {
          const date = new Date(order.timestamp);
          const time = date.toLocaleString('vi-VN');
          const isBuy = order.type === 'buy';
          const side = isBuy ? 'Mua' : 'B√°n';
          const sideClass = isBuy ? 'text-success' : 'text-danger';
          const filled = parseFloat(order.filled || 0);
          const amount = parseFloat(order.amount || 0);
          const filledPercent = ((filled / amount) * 100).toFixed(0);
          
          return `
            <tr>
              <td>${time}</td>
              <td><strong>${order.pair}</strong></td>
              <td>Limit</td>
              <td class="${sideClass}">${side}</td>
              <td>$${parseFloat(order.price).toLocaleString()}</td>
              <td>${amount.toFixed(4)} ETH</td>
              <td>${filled.toFixed(4)} (${filledPercent}%)</td>
              <td>$${(order.price * amount).toLocaleString()}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="cancelOrder(${index})">
                  <i class="fas fa-times"></i> H·ªßy
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Cancel order function
      window.cancelOrder = function(index) {
        const openOrders = JSON.parse(localStorage.getItem('openOrders') || '[]');
        const canceledOrder = openOrders[index];
        
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy l·ªánh ${canceledOrder.type === 'MUA' ? 'MUA' : 'B√ÅN'} ${canceledOrder.amount} ETH?`)) {
          openOrders.splice(index, 1);
          localStorage.setItem('openOrders', JSON.stringify(openOrders));
          loadOpenOrders();
          alert('‚úÖ ƒê√£ h·ªßy l·ªánh th√†nh c√¥ng');
        }
      };

      // Load recent trades (simulated real-time)
      function loadRecentTrades() {
        const recentTradesTable = document.getElementById('recentTrades');
        const currentPrice = parseFloat(document.getElementById('currentPrice').textContent.replace(/[$,]/g, ''));
        
        // Generate random recent trades
        const trades = [];
        for (let i = 0; i < 15; i++) {
          const priceVariation = (Math.random() - 0.5) * 10;
          const price = currentPrice + priceVariation;
          const amount = (Math.random() * 2).toFixed(4);
          const isBuy = Math.random() > 0.5;
          const now = new Date();
          now.setSeconds(now.getSeconds() - i * 3);
          
          trades.push({
            price: price.toFixed(2),
            amount: amount,
            time: `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`,
            isBuy: isBuy
          });
        }
        
        recentTradesTable.innerHTML = trades.map(trade => `
          <tr>
            <td class="${trade.isBuy ? 'text-success' : 'text-danger'}">${parseFloat(trade.price).toLocaleString()}</td>
            <td class="text-end">${trade.amount}</td>
            <td class="text-end text-muted">${trade.time}</td>
          </tr>
        `).join('');
      }

      // Generate random number with variation
      function randomAmount(min, max, decimals = 4) {
        const amount = Math.random() * (max - min) + min;
        return amount.toFixed(decimals);
      }

      function randomPrice(basePrice, variationPercent = 0.5) {
        const variation = basePrice * (variationPercent / 100);
        const randomVar = (Math.random() - 0.5) * 2 * variation;
        return basePrice + randomVar;
      }

      // Load recent trades with random data
      function loadRecentTrades() {
        const recentTradesTable = document.getElementById('recentTrades');
        const currentPrice = parseFloat(document.getElementById('currentPrice').textContent.replace(/[$,]/g, ''));
        
        // Generate random recent trades with natural variation
        const trades = [];
        for (let i = 0; i < 15; i++) {
          const priceVar = randomPrice(currentPrice, 0.3); // 0.3% variation
          const amount = randomAmount(0.0123, 2.8765, 4);
          const isBuy = Math.random() > 0.5;
          const now = new Date();
          now.setSeconds(now.getSeconds() - i * Math.floor(Math.random() * 8 + 2)); // Random interval
          
         
          
          trades.push({
            price: priceVar.toFixed(2),
            amount: amount,
            time: `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`,
            isBuy: isBuy
          });
        }
        
        recentTradesTable.innerHTML = trades.map(trade => `
          <tr>
            <td class="${trade.isBuy ? 'text-success' : 'text-danger'}">${parseFloat(trade.price).toLocaleString()}</td>
            <td class="text-end">${trade.amount}</td>
            <td class="text-end text-muted">${trade.time}</td>
          </tr>
        `).join('');
      }

      // Update order book with random natural data
      function updateOrderBook() {
        const currentPrice = parseFloat(document.getElementById('currentPrice').textContent.replace(/[$,]/g, ''));
        const sellOrdersTable = document.getElementById('sellOrders');
        const buyOrdersTable = document.getElementById('buyOrders');
        
        // Generate sell orders (above current price) with random amounts
        const sellOrders = [];
        for (let i = 3; i >= 1; i--) {
          const priceOffset = Math.random() * 5 + i * 1.2; // Random offset
          const price = currentPrice + priceOffset;
          const amount = randomAmount(0.1234, 8.9876, 4);
          const total = (price * parseFloat(amount)).toFixed(2);
          sellOrders.push({ price, amount, total });
        }
        
        // Sort by price descending
        sellOrders.sort((a, b) => b.price - a.price);
        
        sellOrdersTable.innerHTML = sellOrders.map(order => `
          <tr class="sell-order">
            <td class="text-danger">${order.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="text-end">${order.amount}</td>
            <td class="text-end">${parseFloat(order.total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          </tr>
        `).join('');
        
        // Generate buy orders (below current price) with random amounts
        const buyOrders = [];
        for (let i = 1; i <= 3; i++) {
          const priceOffset = Math.random() * 5 + i * 1.2; // Random offset
          const price = currentPrice - priceOffset;
          const amount = randomAmount(0.2345, 7.6543, 4);
          const total = (price * parseFloat(amount)).toFixed(2);
          buyOrders.push({ price, amount, total });
        }
        
        // Sort by price descending
        buyOrders.sort((a, b) => b.price - a.price);
        
        buyOrdersTable.innerHTML = buyOrders.map(order => `
          <tr class="buy-order">
            <td class="text-success">${order.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td class="text-end">${order.amount}</td>
            <td class="text-end">${parseFloat(order.total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          </tr>
        `).join('');
        
        // Update current price in order book
        document.querySelector('.current-price-row strong').textContent = currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.querySelector('.current-price-row small').textContent = `‚âà $${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      }

      // Load all history on page load
      loadOrderHistory();
      loadTradeHistory();
      loadOpenOrders();
      loadRecentTrades();
      
      // Refresh prices every 30 seconds
      setInterval(loadRealPrice, 30000);
      
      // Refresh chart every 5 minutes
      setInterval(loadChartData, 300000); // Auto-refresh chart every 5 mins with current timeframe
      
      // Update order book and trades more frequently for natural feel
      setInterval(() => {
        loadRecentTrades();
        updateOrderBook();
      }, 2000 + Math.random() * 2000); // Random interval 2-4 seconds
      
      // Refresh history when tab is switched
      document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
          if (e.target.getAttribute('href') === '#orderHistory') {
            loadOrderHistory();
          } else if (e.target.getAttribute('href') === '#tradeHistory') {
            loadTradeHistory();
          } else if (e.target.getAttribute('href') === '#openOrders') {
            loadOpenOrders();
          }
        });
      });

      // Initialize everything after a short delay
      setTimeout(() => {
        console.log('üöÄ Starting initialization...');
        autoConnectWallet();
        loadRealPrice();
        loadChartData(); // This will use default 4H timeframe
        loadOrderHistory();
        loadTradeHistory();
        loadOpenOrders();
        loadRecentTrades();
        
        setInterval(loadRealPrice, 30000);
        setInterval(loadChartData, 300000); // Auto-refresh chart every 5 mins with current timeframe
        setInterval(() => {
          loadRecentTrades();
          updateOrderBook();
        }, 2000 + Math.random() * 2000);
        
        console.log('‚úÖ App initialized successfully');
      }, 500);

    }); // End DOMContentLoaded
  </script>
</body>
</html>

